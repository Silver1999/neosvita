var cellEdit=$("#cellEdit"),currentCell=null,editedSkips=[],editing=!1,errorText="Виникла помилка.",isFilteredByDay=!1;function getEditedSkips(){var t=[];return $(".sheet__itemDaySkips.edited").each(function(){var e=[];$(this).find(".cell-skip").each(function(){e[$(this).data("idx")]=$(this).data("val")}),t.push({user:$(this).data("user"),day:$(this).data("day"),week:$(this).data("w"),status:e})}),t}function undoCells(e){for(;e.length;){var t=e.pop();switch(t.value){case 0:t.cell.removeClass("pp bp sp").data("val",0);break;case 1:t.cell.removeClass("pp bp").addClass("sp").data("val",1);break;case 2:t.cell.removeClass("bp sp").addClass("pp").data("val",2);break;case 3:t.cell.removeClass("pp sp").addClass("bp").data("val",3)}}}function saveButtonClick(){$(".sheet__itemRow .sheet__itemDaySkips.edited").each(function(){$(this).removeClass("edited")}),editing=!1,editedSkips.length=0,$(".list__edit").find(".list__editSubmit, .list__editCancel").hide().siblings(".list__editEdit, .list__sendSubmit, .list__exelExport").show(),cellEdit.hide()}function skipsCount(){$(".sheet__itemRow").each(function(){var e=$(this).find(".pp").length,t=$(this).find(".bp").length,i=e+t;$(this).find(".ppCount").html(e),$(this).find(".bpCount").html(t);var s=$(this).find(".sumCount");s.html(i),i<20?s.removeClass("text-warning text-danger"):i<30?s.addClass("text-warning").removeClass("text-danger"):s.addClass("text-danger").removeClass("text-warning")})}function skipsCountWithDayFilter(e){e.each(function(){var e=$(this).find(".pp").length,t=$(this).find(".bp").length,i=e+t,s=$(this).parent().siblings(".ppCount");s.data("sum",s.text()).html(e),(s=s.siblings(".bpCount")).data("sum",s.text()).html(t),(s=s.siblings(".sumCount")).data("sum",s.text()).html(i),i<20?s.removeClass("text-warning text-danger"):i<30?s.addClass("text-warning").removeClass("text-danger"):s.addClass("text-danger").removeClass("text-warning")})}function resizeCellMid(){$(".sheet__sortRow .cell-mid").css("width",$(".sheet__content .sheet__days").outerWidth())}function resetSign(e){e.removeClass("active").find(".select__item-first").data("id",0).removeClass("select__item-active").html("0")}$(document).ready(function(){resizeCellMid(),$(window).resize(function(){resizeCellMid()}),$(".list__filterMode").click(function(e){var t=$(e.target),i=0;if(!t.is(".select__item")||t.is(".select__item-first")||t.is(".clearSelect")||(i=t.data("id")),i){$(this).data("type",i).siblings(".list__filterBlock").hide();var s="";switch($("#sheet .filtered").removeClass("filtered"),$(".sheet__sortRow .cell-mid").css("width",$(".sheet__days").outerWidth()),isFilteredByDay&&3!=i&&($(".sheet__itemRow").find(".ppCount, .bpCount, .sumCount").each(function(){$(this).html($(this).data("sum"))}),isFilteredByDay=!1),i){case 1:s=".list__filterBlockFIO";break;case 2:s=".list__filterBlockSkips";break;case 3:s=".list__filterBlockDay"}var l=$(this).siblings(s).show().children().hide().filter(".list__filterData").show();resetSelect(l)}}),$(".clearSelect").click(function(e){e.stopImmediatePropagation();var t=$(this).parent().parent(),i=t.siblings(".list__filterBlock:visible").hide();i.length&&(i.children().hide(),resetSelect(i.find(".list__filterData").hide()),i.find(".list__filterVal").val(""),resetSign(i.find(".list__filterSign"))),t.siblings(".select-active").removeClass("select-active"),t.removeClass("select-active"),resetSelect(t)}),$(".list__filterData").click(function(e){var t=$(e.target),i=window.innerWidth<993;if(!t.is(".select__item-first")){switch($(".list__filterMode").data("type")){case 1:$(this).siblings(".list__filterVal").val("");break;case 2:$(this).siblings(".list__filterSign").removeClass("active").find(".select__item-first").removeClass("select__item-active").data("id",0).html("0"),$(this).siblings(".list__filterVal").val("").mask("9999",{autoclear:!1,placeholder:" "});break;case 3:$(this).siblings(".list__filterVal").val("").mask("99.99.9999",{autoclear:!1,placeholder:" "})}i?$(this).hide().siblings().show().parent().addClass("mob").siblings(" .list__filterMode").hide():$(this).siblings().not(".list__filterCancel").show()}}),$(".list__filterSign").click(function(e){$(e.target).is(".select__item-first")||$(this).addClass("active")}),$(".list__filterSubmit").click(function(e){var t=$(this).siblings(".list__filterMode"),i=t.find(".select__item-first").data("id");if(i)switch(t.removeClass("error"),i){case 1:if((r=$(this).siblings(".list__filterBlockFIO")).find(".error").removeClass("error"),!(d=r.find(".list__filterData")).find(".select__item-first").data("id"))return void d.addClass("error");var s=(n=r.find(".list__filterVal")).val().trim();s.length?(n.removeClass("error"),$(".sheet__content .sheet__itemRow").each(function(){0==$(this).find(".cell-name").text().trim().indexOf(s)?$(this).removeClass("filtered"):$(this).addClass("filtered")})):(n.addClass("error"),$(".sheet__content .sheet__itemRow").each(function(){$(this).removeClass("filtered")}));break;case 2:if((r=$(this).siblings(".list__filterBlockSkips")).find(".error").removeClass("error"),!(d=r.find(".list__filterData")).find(".select__item-first").data("id"))return void d.addClass("error");var l=r.find(".list__filterSign .select__item-first").data("id");"0"==l&&r.find(".list__filterSign").addClass("error");var a=parseInt(r.find(".list__filterVal").val());r.find(".error").length<1?$(".sheet__content .sheet__itemRow").each(function(){var e=parseInt($(this).find(".sumCount").text());switch(l){case 1:e<=a?$(this).addClass("filtered"):$(this).removeClass("filtered");break;case 2:a<=e?$(this).addClass("filtered"):$(this).removeClass("filtered");break;case 3:e!=a?$(this).addClass("filtered"):$(this).removeClass("filtered");break;case 4:e<a?$(this).addClass("filtered"):$(this).removeClass("filtered");break;case 5:a<e?$(this).addClass("filtered"):$(this).removeClass("filtered")}}):$(".sheet__content .sheet__itemRow").each(function(){$(this).removeClass("filtered")});break;case 3:var r,d;if(!(d=(r=$(this).siblings(".list__filterBlockDay")).find(".list__filterData")).find(".select__item-first").data("id"))return void d.addClass("error");var n=r.find(".list__filterVal");r.find(".error").removeClass("error"),(a=n.val().trim()).match(/^\d\d.\d\d\.\d\d\d\d$/g)?(n.removeClass("error"),$(".sheet__days .cell-day").each(function(){var e=$(this).find(".dayDate").text().trim(),t=$(this).data("id");if(a==e){$(this).removeClass("filtered").addClass("visible");var i=$('.sheet__itemDaySkips[data-day="'+t+'"]');i.removeClass("filtered").addClass("visible"),isFilteredByDay=!0,skipsCountWithDayFilter(i)}else $(this).addClass("filtered").removeClass("visible"),$('.sheet__itemDaySkips[data-day="'+t+'"]').addClass("filtered").removeClass("visible")}),$(".sheet__sortRow .cell-mid").css("width",$(".sheet__days").outerWidth())):n.addClass("error")}else t.addClass("error")}),$(".list__filterCancel").click(function(){$(this).siblings().removeClass("error").filter(".list__filterVal").val(""),resetSign($(this).siblings(".list__filterSign"));var e=$(this).hide().siblings().hide().filter(".list__filterData");resetSelect(e);var t=$(this).parent().removeClass("mob").siblings(".list__filterMode").show();resetSelect(t)}),$(".sheet__sortRow .sheet__cell").click(function(){$(this).toggleClass("desc").siblings(".desc").removeClass("desc");for(var e=["sheetSortN","sheetSortName","sheetSortPP","sheetSortBP","sheetSortSUM"],t="",i=0;i<e.length;i++)if($(this).is("."+e[i])){t=e[i];break}var s=$.makeArray($(".sheet__content .sheet__itemRow")),l=null,a="",r=$(this).is(".desc");switch(t){case"sheetSortN":a=".cell-n";break;case"sheetSortName":a=".cell-name";break;case"sheetSortPP":a=".ppCount";break;case"sheetSortBP":a=".bpCount";break;case"sheetSortSUM":a=".sumCount"}a&&(l=".cell-name"==a?function(e,t){var i=$(e).find(a).text().toUpperCase(),s=$(t).find(a).text().toUpperCase();return r?s<i?-1:i<s?1:0:i<s?-1:s<i?1:0}:function(e,t){var i=parseInt($(e).find(a).text()),s=parseInt($(t).find(a).text());return r?s-i:i-s}),l&&(s.sort(l),$(s).appendTo(".sheet__content"))}),$(".cell-skip").click(function(){editing&&($(this).append(cellEdit),currentCell=$(this),$(this).data("idx")<4?cellEdit.addClass("cellEdit-left").removeClass("cellEdit-right"):cellEdit.addClass("cellEdit-right").removeClass("cellEdit-left"),cellEdit.show())}),$(".cellEditCell").click(function(e){if(e.stopPropagation(),!$.isEmptyObject(currentCell))switch(editedSkips.push({cell:currentCell,value:currentCell.data("val")}),$(this).data("val")){case-1:return void cellEdit.hide();case 0:currentCell.removeClass("pp bp sp").data("val",0);break;case 1:currentCell.removeClass("pp bp").addClass("sp").data("val",1);break;case 2:currentCell.removeClass("bp sp").addClass("pp").data("val",2);break;case 3:currentCell.removeClass("pp sp").addClass("bp").data("val",3)}currentCell.parent().addClass("edited"),cellEdit.hide()}),$(".list__switch").click(function(e){var t=$(e.target);if(t.is(".list__switchCase")){t.siblings().removeClass("active").end().addClass("active");var i=$("#sheet");i.find(".visible").removeClass("visible"),i.find("."+t.data("col")).addClass("visible"),$(".sheet__sortRow .cell-mid").css("width",i.find(".sheet__days").outerWidth())}}),$(".list__editEdit").click(function(){$(this).hide().siblings(".list__sendSubmit, .list__exelExport").hide().siblings(".list__editCancel, .list__editSubmit").show(),$(".btnEditDiscipleName").show(),editing=!0}),$(".list__editCancel").click(function(){editedSkips.length&&undoCells(editedSkips),saveButtonClick()}),$(".list__editSubmit").click(function(){var e=getEditedSkips(),t={};e.length&&(t.skips=e),$.isEmptyObject(t)?saveButtonClick():$.post("tableUpdate",JSON.stringify(t)).done(function(e){"ok"==e?(saveButtonClick(),skipsCount(),isFilteredByDay&&skipsCountWithDayFilter($(".sheet__itemDaySkips").not(".filtered"))):alert(errorText)}).fail(function(){alert(errorText)})}),$(".list__period").click(function(e){var t=$(e.target);if(t.is(".select__item")&&!t.is(".select__item-first")){var i=t.data("id"),s=$(".list__search");if(checkInput(s.find(".list__group")),checkSelect(s.find(".list__institution")),!s.find(".error").length){var l={institution:s.find(".list__institution .select__item-first").data("id"),group:s.find(".list__group").val().trim(),period:i},a="";switch($(this).data("type")){case"week":a="getWeekTable";break;case"month":a="getMonthTable";break;case"semester":a="getYearTable"}!$.isEmptyObject(l)&&a.length&&$.post(a,JSON.stringify(l)).done(function(e){var t=$("#listContent");t.html(e).find(".cell-mid").css("width",t.find(".sheet__days").outerWidth())}).fail(function(){alert(errorText)})}scrollTo(".list__search",1e3)}}),$(".sheetSwitch__button").click(function(e){$(this).addClass("sheetSwitch__button-active").siblings().removeClass("sheetSwitch__button-active");var t=$(".list__search"),i={institution:t.find(".list__institution .select__item-first").data("id"),group:t.find(".list__group").val(),period:0},s="";switch($(this).data("val")){case"week":s="getWeekTable";break;case"month":s="getMonthTable";break;case"semester":s="getYearTable"}!$.isEmptyObject(i)&&s.length&&$.post(s,JSON.stringify(i)).done(function(e){var t=$("#listContent");t.html(e).find(".cell-mid").css("width",t.find(".sheet__days").outerWidth())}).fail(function(){alert(errorText)})}),$(".list__exelExport").click(function(){$.ajax({url:"getExcel/export",method:"GET",xhrFields:{responseType:"blob"},success:function(e){var t=document.createElement("a"),i=window.URL.createObjectURL(e);t.href=i,t.download="ВІДОМІСТЬ.xlsx",document.body.append(t),t.click(),t.remove(),window.URL.revokeObjectURL(i)}})}),$(".list__sendSubmit").click(function(){$.post("getExcel/send","").done(function(){$("#overlay").show()}).fail(function(){alert(errorText)})}),$(".modalSended .button-ok").click(function(){$("#overlay").hide()})});